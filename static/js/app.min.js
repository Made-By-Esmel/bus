const $=e=>document.getElementById(e),el={appShell:$("appShell"),statusText:$("statusText"),statusDot:$("statusDot"),statusPill:$("statusPill"),searchBtn:$("searchBtn"),btnText:$("btnText"),btnIcon:$("btnIcon"),noticeBox:$("noticeBox"),noticeTitle:$("noticeTitle"),noticeText:$("noticeText"),noticeActions:$("noticeActions"),lookupForm:$("lookupForm"),progressBar:$("progressBar"),resetBtn:$("resetBtn"),agency:$("agency"),busId:$("busId"),headline:$("headline"),year:$("year"),length:$("length"),ptype:$("ptype"),line:$("line"),lineWrap:$("lineWrap"),emptyState:$("emptyState"),specUI:$("specUI")},tokenMeta=document.querySelector('meta[name="csrf-token"]'),CSRF_TOKEN=tokenMeta?.content||null,CSRF_HEADERS=CSRF_TOKEN?{"X-CSRF-Token":CSRF_TOKEN}:{},DOT="h-2.5 w-2.5 rounded-full ring-2 ring-white/20 shadow-sm",DOT_COLOR={ready:"bg-slate-500",loading:"bg-amber-400",ok:"bg-emerald-400",error:"bg-rose-400"},BOX_BASE="mt-5 rounded-2xl border px-4 py-3 text-sm shadow-lg shadow-black/30 backdrop-blur",BOX={error:`${BOX_BASE} border-rose-400/30 bg-rose-500/10 text-rose-100`,suggest:`${BOX_BASE} border-amber-300/30 bg-amber-400/10 text-amber-100`,info:`${BOX_BASE} border-sky-300/30 bg-sky-400/10 text-sky-100`,hidden:"mt-5 hidden rounded-2xl border px-4 py-3 text-sm"},ACTION_BTN="inline-flex items-center justify-center rounded-full bg-white/10 px-3.5 py-1.5 text-xs font-semibold text-white/90 ring-1 ring-white/15 transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-emerald-300/40",animateNode=e=>{e&&(e.classList.remove("animate-in"),e.offsetWidth,e.classList.add("animate-in"))},setStatus=(e,t)=>{el.statusText.textContent=t,el.statusDot.className=`${DOT} ${DOT_COLOR[e]||""}`.trim(),el.statusPill&&(el.statusPill.dataset.status=e),el.appShell&&(el.appShell.dataset.status=e)},setLoading=e=>{el.searchBtn.disabled=e,el.btnText.textContent=e?"Searching…":"Lookup",el.btnIcon.classList.toggle("hidden",e),el.lookupForm&&el.lookupForm.setAttribute("aria-busy",e?"true":"false"),el.progressBar&&el.progressBar.classList.toggle("is-active",e)},clearNotice=()=>{el.noticeBox.className=BOX.hidden,el.noticeTitle.textContent="",el.noticeText.textContent="",el.noticeActions.innerHTML="",el.noticeBox.classList.remove("animate-in")},showErrorNotice=e=>{el.noticeBox.className=BOX.error,el.noticeTitle.textContent="Error",el.noticeText.textContent=e,el.noticeActions.innerHTML="",el.noticeBox.classList.remove("hidden"),animateNode(el.noticeBox)},applySuggestion=(e,t)=>{const n=(e.key||"").toLowerCase();el.agency.value=n||e.key||"",el.busId.value=t,setStatus("loading",`Switching to ${e.name??e.key}…`),clearNotice(),el.lookupForm.dispatchEvent(new Event("submit",{cancelable:!0,bubbles:!0}))},showSuggestionNotice=(e,t,n)=>{if(!Array.isArray(e)||!e.length)return;el.noticeBox.className=BOX.suggest;const o=e.length>1;el.noticeTitle.textContent=n||(o?"Found in other agencies.":"Found under another agency."),el.noticeText.textContent=o?"We found this vehicle in multiple agencies. Choose one to search.":`We found this vehicle under ${e[0].name}. Switch agency and retry?`,el.noticeActions.innerHTML="",e.forEach(e=>{const n=document.createElement("button");n.type="button",n.className=ACTION_BTN,n.textContent=`Try ${e.name??e.key}`,n.addEventListener("click",()=>applySuggestion(e,t)),el.noticeActions.appendChild(n)}),el.noticeBox.classList.remove("hidden"),animateNode(el.noticeBox)},formatAgencyList=e=>{if(!e?.length)return"";if(1===e.length)return e[0];const[t,...n]=e.slice().reverse();return`${n.reverse().join(", ")} and ${t}`},showAlsoFoundNotice=(e,t)=>{if(!Array.isArray(e)||!e.length)return;const n=e.map(e=>e.name??e.key).filter(Boolean),o=n.length?formatAgencyList(n):"another agency";el.noticeBox.className=BOX.info,el.noticeTitle.textContent="Also found elsewhere.",el.noticeText.textContent=`We also found ${t||"this ID"} in ${o}.`,el.noticeActions.innerHTML="",e.forEach(e=>{const n=document.createElement("button");n.type="button",n.className=ACTION_BTN,n.textContent=`Switch to ${e.name??e.key}`,n.addEventListener("click",()=>applySuggestion(e,t)),el.noticeActions.appendChild(n)}),el.noticeBox.classList.remove("hidden"),animateNode(el.noticeBox)},normSeries=e=>(e??"").toString().trim()||null,extractSpec=e=>{if(!e||"object"!=typeof e)throw new Error("API returned an invalid response.");return e.spec&&"object"==typeof e.spec?e.spec:e},renderSpec=e=>{if(!e||"object"!=typeof e)throw new Error("Response missing spec fields.");const t=e.make??"Unknown make",n=e.model??"Unknown model",o=e.year??"—",s=e.propulsion_type??"—",r=e.length_ft??"—",i=normSeries(e.series);let a=(e.display_name??"").toString().trim()||null;if(!a){let e=i;if(i&&t){const[n]=t.split(/\s+/),[o]=i.split(/\s+/);n&&o&&n.toLowerCase()===o.toLowerCase()&&(e=i.split(/\s+/).slice(1).join(" ").trim()||null)}a=[o,t,e,n].filter(Boolean).join(" ")}el.headline.textContent=a,el.year.textContent=o,el.length.textContent=`${r} ft`,el.ptype.textContent=s,el.lineWrap.classList.toggle("hidden",!i),el.line.textContent=i||"",el.emptyState.classList.add("hidden"),el.specUI.classList.remove("hidden"),animateNode(el.specUI)},normalizeAgencyList=e=>{const t=(Array.isArray(e)?e:[]).map(e=>{if(!e)return null;if("string"==typeof e)return{key:e,name:e};const t=e.key??e.agency??e.id??null;return t?{key:t,name:e.display_name??e.name??t}:null}).filter(Boolean);return t.length?t:null},normalizeSuggestions=e=>{if(!e||"object"!=typeof e)return null;const t=Array.isArray(e.suggested_agencies)?e.suggested_agencies:e.suggested_agency?[{key:e.suggested_agency,name:e.suggested_agency_name??e.suggested_agency}]:[];return normalizeAgencyList(t)},normalizeAlsoFound=e=>normalizeAgencyList(e);async function fetchFleetSpec({agency:e,busId:t}){const n=`/api/fleet?agency=${encodeURIComponent(e)}&busId=${encodeURIComponent(t)}`,o=await fetch(n,{headers:CSRF_HEADERS,referrerPolicy:"same-origin"}),s=await o.text(),r=s?(()=>{try{return JSON.parse(s)}catch{return null}})():null;if(o.ok)return{ok:!0,data:r,alsoFound:normalizeAlsoFound(r?.also_found_in)};const i=r?.detail,a=normalizeSuggestions(i);if(a)return{ok:!1,suggestions:a,message:i&&"object"==typeof i&&"string"==typeof i.message&&i.message||null};const l="string"==typeof i&&i||i&&"object"==typeof i&&i.message||null;throw new Error(l??`API error: ${o.status}`)}el.lookupForm.addEventListener("submit",async e=>{e.preventDefault(),clearNotice();const t=el.agency.value,n=el.busId.value.trim();if(!n)return showErrorNotice("Please enter a vehicle ID.");if(!CSRF_TOKEN)return setStatus("error","CSRF missing."),showErrorNotice("CSRF token missing. Refresh the page and try again.");setStatus("loading","Scanning registry…"),setLoading(!0);try{const e=await fetchFleetSpec({agency:t,busId:n});if(e.ok)renderSpec(extractSpec(e.data)),e.alsoFound&&showAlsoFoundNotice(e.alsoFound,n),setStatus("ok","Match confirmed."),setTimeout(()=>setStatus("ready","Ready."),900);else{if(!e.suggestions)throw new Error("Vehicle not found.");{const t=e.suggestions.length>1;setStatus("error",t?"Found in multiple agencies.":"Found under another agency."),showSuggestionNotice(e.suggestions,n,e.message)}}}catch(e){setStatus("error","Error."),showErrorNotice(e?.message||"Something went wrong.")}finally{setLoading(!1)}}),el.resetBtn.addEventListener("click",()=>{clearNotice(),el.agency.selectedIndex=0,el.busId.value="",el.specUI.classList.add("hidden"),el.emptyState.classList.remove("hidden"),setStatus("ready","Ready."),el.busId.focus()}),el.busId.focus();